name: Daily Pipeline

# Chained: incremental discover → enrich pending → vibe score
# Runs once daily. Manual trigger also available.

on:
  schedule:
    - cron: '0 4 * * *'   # 04:00 UTC daily
  workflow_dispatch:

jobs:
  # ── Job 1: Incremental discover (capped at 500 new repos) ──────────
  discover:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Incremental discover
        run: node scripts/scrape-github.mjs --enrich-limit 500
        timeout-minutes: 25
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ── Job 2: Enrich pending raw_repos through Gemini ─────────────────
  enrich:
    needs: discover
    runs-on: ubuntu-latest
    timeout-minutes: 60

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enrich pending repos
        run: node scripts/scrape-github.mjs --enrich --enrich-limit 200
        timeout-minutes: 55
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

  # ── Job 3: Compute vibe scores ─────────────────────────────────────
  vibe-score:
    needs: enrich
    runs-on: ubuntu-latest
    timeout-minutes: 90

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Compute vibe scores
        run: node scripts/vibe-score.mjs
        timeout-minutes: 85
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Daily pipeline failed at vibe-score stage"
          exit 1
