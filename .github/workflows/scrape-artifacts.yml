name: Scrape Artifacts (Manual)

# Manual-only — for initial bulk loads or one-off runs.
# The daily automated pipeline is in daily-pipeline.yml.

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Scraper mode'
        required: true
        default: 'discover'
        type: choice
        options:
          - discover
          - enrich
          - bulk
          - registries
      enrich_limit:
        description: 'Max repos to enrich (enrich/bulk modes)'
        required: false
        default: '2000'
        type: string
      artifact_type:
        description: 'Filter to one artifact type (discover mode)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - mcp-server
          - skill
          - cursor-rules
          - n8n-node
          - workflow
          - langchain-tool
          - crewai-tool

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Discover only — GitHub search → raw_repos (no Gemini)
      - name: Discover (GitHub)
        if: inputs.mode == 'discover'
        run: |
          ARGS="--discover"
          if [ "${{ inputs.artifact_type }}" != "all" ]; then
            ARGS="$ARGS --type ${{ inputs.artifact_type }}"
          fi
          node scripts/scrape-github.mjs $ARGS
        timeout-minutes: 110
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Registries — npm + PyPI + awesome lists (no GitHub API needed)
      - name: Discover (Registries)
        if: inputs.mode == 'registries'
        run: node scripts/scrape-registries.mjs --all
        timeout-minutes: 60
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      # Enrich only — raw_repos → Gemini → artifacts
      - name: Enrich
        if: inputs.mode == 'enrich'
        run: node scripts/scrape-github.mjs --enrich --enrich-limit ${{ inputs.enrich_limit || '2000' }}
        timeout-minutes: 85
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      # Bulk — full discover (GitHub + registries) + enrich
      - name: Bulk (GitHub discover)
        if: inputs.mode == 'bulk'
        run: node scripts/scrape-github.mjs --discover --time-budget 50
        timeout-minutes: 55
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Bulk (Registry discover)
        if: inputs.mode == 'bulk'
        run: node scripts/scrape-registries.mjs --all --time-budget 20
        timeout-minutes: 25
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Bulk (Enrich)
        if: inputs.mode == 'bulk'
        run: node scripts/scrape-github.mjs --enrich --enrich-limit ${{ inputs.enrich_limit || '2000' }}
        timeout-minutes: 30
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
